!function(e){var t,n,r,i,o,a=((t={})._stores={},t.baseUrl="",t.isProduction=!0,t.constants={},t.isBrowser=!0,t.urlsGraph={},t.cacheGraph={},t.isOfflineStrategies=!1,t.isOfflineSync=!1,t.version="",t.setOptions=function(e){for(option in e)t[option]=e[option]},t),s=function(e,t){var n=e[0];function r(e,t,r,i){if(!n.IS_PRODUCTION){Array.isArray(e)||(e=[e]);var o=r+e.join(" ");if(!t)return i(o);i(r+e.join(" "),t)}}return{info:function(e,t){return r(e,t,"[Lunaris info]",console.log)},warn:function(e,t){return r(e,t,"[Lunaris error] ",console.error)},tip:function(e,t){return r(e,t,"[Lunaris tip] ",console.warn)},deprecated:function(e,t){return r(e,t,"[Lunaris deprecated]",console.warn)},debug:function(e,t){return r(e,t,"[Lunaris debug]",console.log)}}}([a]),l=function(e,t){var n=e[0],r=e[1];function i(e){var t=/(.*)@(.*)/.exec(e);if(!t||t.length<3)throw new Error("A hook must be: <event>@<store>");return{event:t[1],store:t[2]}}function o(e){if("function"!=typeof e)throw new Error("A handler must be a Function")}return t.hook=function(t,r,a,s){try{o(r);var l=i(t),u=e[2]._stores[l.store];if(!u)throw new Error('Cannot register hook "'+t+'", store "'+l.store+'" has not been defined!');if(u.isInternalHooks||(u.isInternalHooks={}),u.realHooks||(u.realHooks={}),u.hooks[l.event]||(u.hooks[l.event]=[],u.realHooks[l.event]=[],u.isInternalHooks[l.event]=[]),a){for(var c=u.realHooks[l.event],f=!1,d=0;d<c.length;d++)if(c[d].toString()===r.toString()){f=!0;break}if(f)return}var v=r;r.length<=1&&(v=function(e,t){r(e),t()}),u.hooks[l.event].push(v),u.isInternalHooks[l.event].push(s||!1),u.realHooks[l.event].push(r)}catch(e){n.warn(["lunaris.hook:"+t],e)}},t.removeHook=function(t,r){try{o(r);var a=i(t),s=e[3]._stores[a.store];if(!s)throw new Error('Cannot remove hook "'+t+'", store "'+a.store+'" has not been defined!');var l=s.realHooks[a.event];if(!l)throw new Error('Cannot remove hook "'+t+'", it has not been defined!');for(var u=0;u<l.length;u++)l[u]===r&&(l.splice(u,1),s.isInternalHooks[a.event].splice(u,1),s.hooks[a.event].splice(u,1))}catch(e){n.warn(["lunaris.removeHook:"+t],e)}},t.pushToHandlers=function(e,t,n,r){var i=e.hooks[t];if(r||(r=function(){}),!i)return r();!function(e,t,n){var r=-1;!function i(){if(++r,!e[r])return n();e[r](t,i)}()}(i,n,r)},t.removeAllHooks=function(){var e=r._stores;for(var t in e){var n=e[t].hooks;for(var i in n)for(var o=n[i],a=e[t].isInternalHooks[i],s=o.length-1;s>=0;s--)a&&a[s]||(o.splice(s,1),a.splice(s,1),e[t].realHooks[i].splice(s,1))}},t}([s,a,a,a],{}),u=function(e,t){var n=e[0].isBrowser;function r(e){var t=null;if("object"!=typeof e||null==e)return e;if(Array.isArray(e)){t=[];for(var n=0;n<e.length;++n){var i=e[n];"object"!==typeof i?t.push(i):t.push(r(i))}return t}for(var o in t={},e){var a=e[o],s=typeof a;a&&a.constructor===Object||Array.isArray(a)?t[o]=r(a):t[o]="object"===s&&a?a.toISOString?a.toISOString():a.toString():"function"!==s?a:void 0}return t}function i(e){return Object.freeze(e)}t.cloneAndFreeze=function(e,t){var n=(t||r)(e);if(!Array.isArray(n))return i(n);for(var o=0;o<n.length;o++)n[o]=i(n[o]);return n},t.keepTheReferenceAndChangeTheAttributes=function(e,t){for(var n=Object.keys(e),r=0;r<n.length;r++)delete e[n[r]];for(n=Object.keys(t),r=0;r<n.length;r++)e[n[r]]=t[n[r]]},t.clone=r,t.freeze=i,t.offlineStore="lunarisOfflineTransactions",t.OPERATIONS={DELETE:"DELETE",INSERT:"POST",UPDATE:"PUT",PATCH:"PATCH",LIST:"GET",RESET:"RESET"},t.OPERATORS={"=":":=",ILIKE:":",">":":>","<":":<",">=":":>=","<=":":<=","<>":":!="},t.merge=function e(t,n){if(!n)return t;if("object"==typeof t&&"object"==typeof n){for(var r=Object.keys(n),i=0;i<r.length;i++){var o=r[i];t[o]&&"object"==typeof n[o]?t[o]=e(t[o],n[o]):t[o]=n[o]}return t}},t.distance=function(e,t){if(null===e||null===t)return 0;var n=function(e,t){for(var n,r,i=[],o=0;o<=t.length;o++)for(var a=0;a<=e.length;a++)r=o&&a?e.charAt(a-1)===t.charAt(o-1)?n:Math.min(i[a],i[a-1],n)+1:o+a,n=i[a],i[a]=r;return i.pop()}(e=String(e),t=String(t));return e.length>t.length?1-n/e.length:1-n/t.length},t.index={sort:function(e,t){return null===e&&null===t?0:null===e?-1:null===t?1:e<t?-1:e>t?1:0},insertAt:function(e,t,n){return e.splice(t,0,n),e},removeAt:function(e,t){return e.splice(t,1),e},getValue:function(e){if("string"==typeof e){var t=e.replace(/^_/,"");return/^-?[0-9]+$/.test(t)?parseInt(t,10):t}return e},binarySearch:function(e,t){for(var n,r,i,o=0,a=e.length,s=this.getValue(t);o<a;){if(r=(o+a)/2|0,i=this.getValue(e[r]),0===(n=this.sort(s,i)))return{found:!0,index:r};n<0?a=r:o=r+1}return{found:!1,index:a}}};for(var o=[{base:"A",letters:"AⒶＡÀÁÂẦẤẪẨÃĀĂẰẮẴẲȦǠÄǞẢÅǺǍȀȂẠẬẶḀĄȺⱯ"},{base:"AA",letters:"Ꜳ"},{base:"AE",letters:"ÆǼǢ"},{base:"AO",letters:"Ꜵ"},{base:"AU",letters:"Ꜷ"},{base:"AV",letters:"ꜸꜺ"},{base:"AY",letters:"Ꜽ"},{base:"B",letters:"BⒷＢḂḄḆɃƂƁ"},{base:"C",letters:"CⒸＣĆĈĊČÇḈƇȻꜾ"},{base:"D",letters:"DⒹＤḊĎḌḐḒḎĐƋƊƉꝹÐ"},{base:"DZ",letters:"ǱǄ"},{base:"Dz",letters:"ǲǅ"},{base:"E",letters:"EⒺＥÈÉÊỀẾỄỂẼĒḔḖĔĖËẺĚȄȆẸỆȨḜĘḘḚƐƎ"},{base:"F",letters:"FⒻＦḞƑꝻ"},{base:"G",letters:"GⒼＧǴĜḠĞĠǦĢǤƓꞠꝽꝾ"},{base:"H",letters:"HⒽＨĤḢḦȞḤḨḪĦⱧⱵꞍ"},{base:"I",letters:"IⒾＩÌÍÎĨĪĬİÏḮỈǏȈȊỊĮḬƗ"},{base:"J",letters:"JⒿＪĴɈ"},{base:"K",letters:"KⓀＫḰǨḲĶḴƘⱩꝀꝂꝄꞢ"},{base:"L",letters:"LⓁＬĿĹĽḶḸĻḼḺŁȽⱢⱠꝈꝆꞀ"},{base:"LJ",letters:"Ǉ"},{base:"Lj",letters:"ǈ"},{base:"M",letters:"MⓂＭḾṀṂⱮƜ"},{base:"N",letters:"NⓃＮǸŃÑṄŇṆŅṊṈȠƝꞐꞤ"},{base:"NJ",letters:"Ǌ"},{base:"Nj",letters:"ǋ"},{base:"O",letters:"OⓄＯÒÓÔỒỐỖỔÕṌȬṎŌṐṒŎȮȰÖȪỎŐǑȌȎƠỜỚỠỞỢỌỘǪǬØǾƆƟꝊꝌ"},{base:"OI",letters:"Ƣ"},{base:"OO",letters:"Ꝏ"},{base:"OU",letters:"Ȣ"},{base:"OE",letters:"Œ"},{base:"oe",letters:"œ"},{base:"P",letters:"PⓅＰṔṖƤⱣꝐꝒꝔ"},{base:"Q",letters:"QⓆＱꝖꝘɊ"},{base:"R",letters:"RⓇＲŔṘŘȐȒṚṜŖṞɌⱤꝚꞦꞂ"},{base:"S",letters:"SⓈＳẞŚṤŜṠŠṦṢṨȘŞⱾꞨꞄ"},{base:"T",letters:"TⓉＴṪŤṬȚŢṰṮŦƬƮȾꞆ"},{base:"TZ",letters:"Ꜩ"},{base:"U",letters:"UⓊＵÙÚÛŨṸŪṺŬÜǛǗǕǙỦŮŰǓȔȖƯỪỨỮỬỰỤṲŲṶṴɄ"},{base:"V",letters:"VⓋＶṼṾƲꝞɅ"},{base:"VY",letters:"Ꝡ"},{base:"W",letters:"WⓌＷẀẂŴẆẄẈⱲ"},{base:"X",letters:"XⓍＸẊẌ"},{base:"Y",letters:"YⓎＹỲÝŶỸȲẎŸỶỴƳɎỾ"},{base:"Z",letters:"ZⓏＺŹẐŻŽẒẔƵȤⱿⱫꝢ"},{base:"a",letters:"aⓐａẚàáâầấẫẩãāăằắẵẳȧǡäǟảåǻǎȁȃạậặḁąⱥɐ"},{base:"aa",letters:"ꜳ"},{base:"ae",letters:"æǽǣ"},{base:"ao",letters:"ꜵ"},{base:"au",letters:"ꜷ"},{base:"av",letters:"ꜹꜻ"},{base:"ay",letters:"ꜽ"},{base:"b",letters:"bⓑｂḃḅḇƀƃɓ"},{base:"c",letters:"cⓒｃćĉċčçḉƈȼꜿↄ"},{base:"d",letters:"dⓓｄḋďḍḑḓḏđƌɖɗꝺ"},{base:"dz",letters:"ǳǆ"},{base:"e",letters:"eⓔｅèéêềếễểẽēḕḗĕėëẻěȅȇẹệȩḝęḙḛɇɛǝ"},{base:"f",letters:"fⓕｆḟƒꝼ"},{base:"g",letters:"gⓖｇǵĝḡğġǧģǥɠꞡᵹꝿ"},{base:"h",letters:"hⓗｈĥḣḧȟḥḩḫẖħⱨⱶɥ"},{base:"hv",letters:"ƕ"},{base:"i",letters:"iⓘｉìíîĩīĭïḯỉǐȉȋịįḭɨı"},{base:"j",letters:"jⓙｊĵǰɉ"},{base:"k",letters:"kⓚｋḱǩḳķḵƙⱪꝁꝃꝅꞣ"},{base:"l",letters:"lⓛｌŀĺľḷḹļḽḻſłƚɫⱡꝉꞁꝇ"},{base:"lj",letters:"ǉ"},{base:"m",letters:"mⓜｍḿṁṃɱɯ"},{base:"n",letters:"nⓝｎǹńñṅňṇņṋṉƞɲŉꞑꞥ"},{base:"nj",letters:"ǌ"},{base:"o",letters:"oⓞｏòóôồốỗổõṍȭṏōṑṓŏȯȱöȫỏőǒȍȏơờớỡởợọộǫǭøǿɔꝋꝍɵ"},{base:"oi",letters:"ƣ"},{base:"ou",letters:"ȣ"},{base:"oo",letters:"ꝏ"},{base:"p",letters:"pⓟｐṕṗƥᵽꝑꝓꝕ"},{base:"q",letters:"qⓠｑɋꝗꝙ"},{base:"r",letters:"rⓡｒŕṙřȑȓṛṝŗṟɍɽꝛꞧꞃ"},{base:"s",letters:"sⓢｓßśṥŝṡšṧṣṩșşȿꞩꞅẛ"},{base:"t",letters:"tⓣｔṫẗťṭțţṱṯŧƭʈⱦꞇ"},{base:"tz",letters:"ꜩ"},{base:"u",letters:"uⓤｕùúûũṹūṻŭüǜǘǖǚủůűǔȕȗưừứữửựụṳųṷṵʉ"},{base:"v",letters:"vⓥｖṽṿʋꝟʌ"},{base:"vy",letters:"ꝡ"},{base:"w",letters:"wⓦｗẁẃŵẇẅẘẉⱳ"},{base:"x",letters:"xⓧｘẋẍ"},{base:"y",letters:"yⓨｙỳýŷỹȳẏÿỷẙỵƴɏỿ"},{base:"z",letters:"zⓩｚźẑżžẓẕƶȥɀⱬꝣ"}],a={},s=0;s<o.length;s++)for(var l=o[s].letters,u=0;u<l.length;u++)a[l[u]]=o[s].base;return t.unaccent=function(e){return e.replace(/[^u0000-u007E]/g,(function(e){return a[e]||e}))},t.queue=function(e,t,n){var r=-1;!function i(){if(r++,!e[r])return n();t(e[r],i)}()},t.getProcessTime=function(e){return n?e?window.performance.now()-e:window.performance.now():0},t.deleteRows=function(e){for(var t=e.length-1;t>=0;t--)1!==e[t]._version.length&&e.splice(t,1)},t}([a],{}),c=function(e,t){var n,r=e[0],i=e[1];var o=[],a=!1;function s(){a||(a=!0,function e(){var t=o.shift();if(!t)return void(a=!1);var n=t.pop(),r=t.slice(1);if(3===t.length&&Array.isArray(t[2])&&t[2].length>1e4)return function(e,t){var n=e[2];for(;n.length>1e4;)l([e[0],e[1],n.splice(0,1e4),n.length?null:t]);n.length&&l([e[0],e[1],n.splice(0,n.length),t])}(t,n),e();r.push((function(t,r){n&&n(t,r),e()})),t[0].apply(null,r)}())}function l(e){if(i.isOfflineStrategies)o.push(e),s();else{var t=e.pop();"function"==typeof t&&t()}}function u(e,t,r){if(!n)return r();try{var i=n.transaction(e,"readwrite")}catch(e){return r(e)}i.onerror=function(e){r(e)},i.onblocked=function(e){r(e)},i.oncomplete=function(){r()};var o=i.objectStore(e);Array.isArray(t)||(t=[t]);for(var a=0,s=t.length;a<s;a++)o.add(t[a])}function c(e,t,r){if(!n)return r();try{var i=n.transaction(e,"readwrite")}catch(e){return r(e)}i.onerror=function(e){r(e)},i.onblocked=function(e){r(e)},i.oncomplete=function(){r()};var o=i.objectStore(e);Array.isArray(t)||(t=[t]);for(var a=0,s=t.length;a<s;a++)o.put(t[a])}function f(e,t,r){if(!n)return r();try{var i=n.transaction(e,"readwrite")}catch(e){return r(e)}i.onerror=function(e){r(e)},i.onblocked=function(e){r(e)},i.oncomplete=function(){r()};var o=i.objectStore(e);Array.isArray(t)||(t=[t]);for(var a=0,s=t.length;a<s;a++)o.delete(t[a])}function d(e,t,r){if(!n)return r();try{var i=n.transaction(e,"readonly")}catch(e){return r(e)}i.onerror=function(e){r(e)},i.onblocked=function(e){r(e)};var o=i.objectStore(e).get(t);o.onsuccess=function(e){r(null,e.target.result)},o.onerror=function(e){r(e)}}function v(e,t){if(!n)return t();try{var r=n.transaction(e,"readonly")}catch(e){return t(e)}r.onerror=function(e){t(e)},r.onblocked=function(e){t(e)};var i=r.objectStore(e).getAll();i.onsuccess=function(e){t(null,e.target.result)},i.onerror=function(e){t(e)}}function h(e,t){if(!n)return t();try{var r=n.transaction(e,"readwrite")}catch(e){return t(e)}r.onerror=function(e){t(e)},r.onblocked=function(e){t(e)},r.oncomplete=function(){t()},r.objectStore(e).clear()}var p={indexedDB:{init:function(e,t,i){window.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,window.indexedDB?(window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction||{READ_WRITE:"readwrite"},window.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange,function(e,t){var n=window.indexedDB.open(e),r=!0;n.onsuccess=function(){n.result.close(),r||window.indexedDB.deleteDatabase(e),t(r)},n.onupgradeneeded=function(){r=!1}}("lunaris",(function(o){var a;if(o){var s=p.localStorage.get("lunaris:indexedDB_version");e<s&&(e=s),a=window.indexedDB.open("lunaris",e)}else a=window.indexedDB.open("lunaris");a.onerror=function(e){r.warn("Error when requesting indexedDB",e.target.error),i&&i(!0)},a.onsuccess=function(e){n=e.target.result,i&&i(null,n),n.onerror=function(e){r.warn("[IndexedDB]",e.target.errorCode)}},a.onupgradeneeded=function(n){p.localStorage.set("lunaris:indexedDB_version",e);for(var r=n.target.result,i=0;i<t.length;i++){var o=t[i];r.objectStoreNames.contains(o)||r.createObjectStore(o,{keyPath:"_rowId"})}r.objectStoreNames.contains("_states")||r.createObjectStore("_states",{keyPath:"store"}),r.objectStoreNames.contains("_invalidations")||r.createObjectStore("_invalidations",{keyPath:"url"}),r.objectStoreNames.contains("cache")||r.createObjectStore("cache",{keyPath:"hash"})}}))):i&&i(!0)},add:function(e,t,r){if(!n)return r?r():void 0;l([u,e,t,r])},upsert:function(e,t,r){if(!n)return r?r():void 0;l([c,e,t,r])},del:function(e,t,r){if(!n)return r?r():void 0;l([f,e,t,r])},get:function(e,t,r){if(!n)return r?r():void 0;l([d,e,t,r])},getAll:function(e,t){if(!n)return t?t():void 0;l([v,e,t])},clear:function(e,t){if(!n)return t?t():void 0;l([h,e,t])}},localStorage:{get:function(e){if(i.isBrowser&&"undefined"!=typeof localStorage){var t=localStorage.getItem(e);return t?JSON.parse(t):null}},set:function(e,t){if(i.isBrowser&&"undefined"!=typeof localStorage)return localStorage.setItem(e,null!=t?JSON.stringify(t):null)},clear:function(e){if(i.isBrowser&&"undefined"!=typeof localStorage)return localStorage.setItem(e,null)}}};return p}([s,a]),f=function(e,t){var n=e[0],r=e[1],i=e[2],o=e[3].indexedDB;function a(t){/@/.test(t)&&(t=(t=t.split("@"))[t.length-1]);var n=e[4];if(!n._stores[t])throw new Error('The store "'+t+'" has not been defined');return n._stores[t]}function s(e,t,n){var i=null;if(n)return i;if(e.getPrimaryKeyFn)return e.getPrimaryKeyFn.call(null,t);if(!e.primaryKey&&!e.isStoreObject)return r.tip('No primary key has been found in store "'+e.name+'", fallback to lunaris object attribute "_id".',"To declare a primary key, use the notation ['<<int>>'] in the map or add the 'primaryKey' attribute in the store description."),t._id;var o=e.primaryKey;if(Array.isArray(o)){i=[];for(var a=0;a<o.length;a++){var s=t[o[a]];if(null==s)return null;i.push(s)}return i.length>1&&(i=i.join("-")),i[0]}return t[e.primaryKey]}function l(e,t,n){var r=i.clone(e),o=n||{},a=r.shift();return r.length?(o[a]=l(r,t),o):(o[a]=t,o)}return t.getStore=a,t.getCollection=function(e){var t=e.data;if(!t)throw new Error('"'+e+'" has not been defined!');return t},t.getCache=function(e){return e.cache},t.getPrimaryKeyValue=s,t.setPrimaryKeyValue=function(e,t,n){var i=s(e,t,!1);if(null==i){if(e.setPrimaryKeyFn)return e.setPrimaryKeyFn.call(null,t,n);if(!e.primaryKey||e.primaryKey&&!e.primaryKey.length)return null;var o=e.primaryKey;return Array.isArray(o)?(null!==t[o[0]]&&void 0!==t[o[0]]||(t[o[0]]="_"+n),o.length>1?r.tip("lunaris cannot set a composite primary key"):"_"):t[e.primaryKey]="_"+n}},t.checkArgs=function(e,t,n){if(void 0===t&&!n)throw new Error("Must have a value, provided value: "+t);if(!e||"string"!=typeof e)throw new Error("Must have a correct store value: @<store>")},t.getTranslatedStoreName=function(e){return a(e).nameTranslated},t.getPathValue=function e(t){var n=i.clone(t),r=n.shift();return n.length?e(t)||null:{}[r]},t.setPathValue=l,t.setObjectPathValues=function(e,t){for(var n=Object.keys(e),r=0;r<n.length;r++)l(n[r].split("."),e[n[r]],t)},t.getJSONPatchPath=function(e){return e.replace(".","/")},t.saveState=function(e,t,r){if(!n.isBrowser)return r?r():void 0;var i={store:e.name,massOperations:e.massOperations,collection:{currentId:t.getCurrentId(),currentRowId:t.getCurrentRowId()}};o.upsert("_states",i,r)},t}([a,s,u,c,a],{}),d=function(e,t){var n=e[0],r=(n.index,n.OPERATIONS),i=e[1].aggregates,o=e[2],a=e[3],s=e[4],l=s.localStorage,u=s.indexedDB,c=1,f=l.get("lunaris:versionNumber",1);function d(){c++,l.set("lunaris:versionNumber",c)}return f&&(c=f),t.collection=function(e,t,s,l,f,v,h,p){var g=[],m=[],b={},y=1,O=1,A={},T=!1,w=null,E=t||!1,S=s||{},_=s?Object.keys(S.joins):[],I=h||{},P=I.stores&&I.stores.length?I.stores:[],k=e,R=l,j=f,D=v,C=[],L={},x={id:[[],[]],references:{}};function F(e,t){if(null==w)return e(D,t);C.push(t)}function N(e,t,n){A[e]&&A[e].push([e,t,n])}function H(e){if(P.length)for(var t in I.references){var n=I.references[t],r=I.referencesFn.get[t](e);x.references[n]||(x.references[n]={});for(var i=0;i<r.length;i++)x.references[n][r[i]]||(x.references[n][r[i]]=[]),-1===x.references[n][r[i]].indexOf(e._id)&&x.references[n][r[i]].push(e._id)}}function q(){for(var e in m=[],b)null!=b[e]&&m.push(g[b[e]])}function B(e,t,n,r){if(e._id&&n){if(k){var s=k(e);if(null!=s){var l=L[s];null==l&&(L[s]=e._id)}}return e._rowId=O++,H(e),R&&R(e,i,o.constants,a),F(u.upsert,e),b[e._id]=g.length,g.push(e)}return e._id=y,y++,H(e),function(e){if(_.length){for(var t={},n=0;n<_.length;n++){var r=S.collections[_[n]];t[_[n]]=r?r.getAll():null}S.joinFns.set(e,t,i,o.constants,a)}}(e),R&&R(e,i,o.constants,a),r||!k||null===(s=k(e))||void 0===e._id?(e._rowId=O++,F(u.upsert,e),b[e._id]=g.length,g.push(e)):null!=(l=L[s])?(e._id=L[s],e._rowId=O,void U(e,t,!1,!0)):(L[s]=e._id,b[e._id]=g.length,e._rowId=O++,g.push(e),void F(u.upsert,e))}function V(e,t){null!=L[t]&&(L[t]=null)}function $(e,t,n,i){if(null==e||"object"!=typeof e)throw new Error("add must have a value. It must be an Object.");if(!t||T)return j&&j(e,o.constants,a),e._version=[t||c],T||d(),B(e,t,n,i),T||q(),e;N(t,e,r.INSERT)}function U(e,t,i,o){if((null===e._id||void 0===e._id)&&!i)return $(e,t);if(!t||T){var a=b[e._id];if(null==a){if(i)return;return $(e,w||null,!0)}var s=w||c,l=g[a],f=l._version[0],d=l._version[1]||s,v=p(e);return l._version[1]=s,function(e){if(P.length)for(var t in I.references){var n=I.references[t],r=I.referencesFn.get[t](e);x.references[n]||(x.references[n]=[[],[]]);for(var i=0;i<r.length;i++)if(x.references[n][r[i]]){var o=x.references[n][r[i]].indexOf(e._id);-1!==o&&(x.references[n][r[i]].splice(o,1),x.references[n][r[i]].length||(x.references[n][r[i]]=null))}}}(l),f===s&&d===s&&l._version[1]>=0?i?(F(u.upsert,l),void(b[e._id]=null)):(n.merge(l,v),l._version.pop(),F(u.upsert,l),l):(F(u.upsert,l),i?(b[e._id]=null,T||q(),l):$(v,w||null,!0,o))}N(t,e,r.UPDATE)}function z(e,t,n){if(!t||T){if(k&&!n){var i=K(e._id);i&&V(e._id,k(i))}else if(k&&n){var o=k(e),a=L[o];null!=a&&(e._id=a,L[o]=null)}return U({_id:e._id},t,!0)}N(t,{value:e,isPK:!!n},r.DELETE)}function K(e,t){if(t){if(null==L[e])return null;e=L[e]}return null==b[e]?null:g[b[e]]}function G(){return A[c]=[],C=[],c}function M(e){var t=[],n=A[e];if(n){T=!0,w=c;for(var i=0;i<n.length;i++)if(n[i][2]===r.INSERT)t.push($(n[i][1],null,!0));else if(n[i][2]===r.UPDATE)t.push(U(n[i][1]));else{var o=z(n[i][1].value,null,n[i][1].isPK);o&&t.push(o)}return C.length&&(u.upsert(D,C),C=[]),A[e]=w,T=!1,w=null,d(),q(),p(t)}}return{get:K,add:$,upsert:U,remove:z,clear:function(){g=[],y=1,O=1,L={},x.references={},m=[],b={}},getFirst:function(){if(g[0])return K(g[0]._id)},begin:G,commit:function(e){var t=M(e);return E?t.length?t[0]:null:t},rollback:function(e){var t=A[e];if(t){e=t;for(var n=[],r=g.length-1;r>=0;r--){var i=g[r]._version[0],o=g[r]._version[1];(e===o||e===i&&!o)&&n.push(p(g[r]))}for(var a=G(),s=0;s<n.length;s++)n[s]._version[0]!==n[s]._version[1]&&(n[s]._version[1]?$(n[s],a):z({_id:n[s]._id},a,!1));return M(a)}},propagate:function(e,t,n){if(S.joinFns[e]){t&&!Array.isArray(t)&&(t=[t]);for(var s=G(),l=0;l<g.length;l++){var u=g[l],f=u._version[0],d=u._version[1];if(f<=c&&!d){var v=p(u);if(t&&t.length)for(var h=0;h<t.length;h++)v=m(v,t[h],n);else v=m(v,null,n);U(v,s)}}return M(s)}function m(t,n,s){return s===r.INSERT||s===r.UPDATE?(S.joinFns[e].delete(t,n,i,o.constants,a),S.joinFns[e].insert(t,n,i,o.constants,a)):s===r.DELETE?S.joinFns[e].delete(t,n,i,o.constants,a):void 0}},replaceReferences:function(e,t,n){if(!I.referencesFn)return[];if(!x.references[e])return[];if(!x.references[e][t])return[];for(var r=G(),i=x.references[e][t],o=0;o<g.length;o++){var a=g[o],s=a._version[0],l=a._version[1];if(s<=c&&!l&&-1!==i.indexOf(a._id)){var u=p(a);for(var f in I.references)I.referencesFn.update[f](t,n,u);U(u,r)}}return M(r)},getIndexId:function(){return L},getIndexReferences:function(){return x.references},getIndexDataCache:function(){return b},removeIndexIdValue:function(e){null!=e&&V(0,"_"+e)},_getAll:function(){return g},_getAllCache:function(){return m},setData:function(e){g=e,function(){for(var e=0,t=0,n=g.length;t<n;t++){var r=g[t];if(!(r._version.length>1)){if(b[r._id]=e,e++,k){var i=k(r);L[i]=r._id}H(r)}}}(),q()},getAll:function(e,t,n){var r=[];if(null==e)r=m;else for(var i=0;i<e.length;i++){var o=e[i];if(t)null!=(a=L[o])&&r.push(g[b[a]]);else{var a=b[o];null!=a&&r.push(g[a])}}return E&&(r=r.length?r[0]:null),!1===n?r:p(r)},getCurrentId:function(){return y},setCurrentId:function(e){y=e},getCurrentVersionNumber:function(){return c},getCurrentRowId:function(){return O},setCurrentRowId:function(e){O=e}}},t.resetVersionNumber=function(){c=1,l.set("lunaris:versionNumber",1)},t}([u,function(e,t){var n=e[0].index,r={sumAgg:{type:"number",init:{start:0},add:function(e,t){return e||(e={value:this.init.start}),{value:e.value+(t||this.init.start)}},remove:function(e,t){return e||(e={value:this.init.start}),{value:e.value-(t||this.init.start)}},getStartValue:function(){return this.init.start}},countAgg:{type:"int",init:{start:0},add:function(e){return e||(e={value:this.init.start}),{value:e.value+1}},remove:function(e){return e||(e={value:this.init.start}),{value:e.value-1}},getStartValue:function(){return this.init.start}},avgAgg:{type:"number",init:{start:0,count:0},add:function(e,t){return e||(e={value:this.init.start,count:this.init.count}),t||(t=0),e.count++,e.value+=(t-e.value)/e.count,e},remove:function(e,t){return e||(e={value:this.init.start,count:this.init.count}),t||(t=0),e.count--,e.value-=(t-e.value)/e.count,e},getStartValue:function(){return this.init.start}},minAgg:{type:"*",init:{start:null,values:[]},add:function(e,t){if(e||(e={value:this.init.start,values:[]}),!t)return e;var r=n.binarySearch(e.values,t);return n.insertAt(e.values,r.index,t),e.value=e.values[0],e},remove:function(e,t){if(e||(e={value:this.init.start,values:[]}),!e.value)return e;var r=n.binarySearch(e.values,t);return r.found&&(n.removeAt(e.values,r.index),e.value=e.values[0]),e},getStartValue:function(){return this.init.start}},maxAgg:{type:"*",init:{start:null,values:[]},add:function(e,t){if(e||(e={value:this.init.start,values:[]}),!t)return e;var r=n.binarySearch(e.values,t);return n.insertAt(e.values,r.index,t),e.value=e.values[e.values.length-1],e},remove:function(e,t){if(e||(e={value:this.init.start,values:[]}),!e.value)return e;var r=n.binarySearch(e.values,t);return r.found&&(n.removeAt(e.values,r.index),e.value=e.values[e.values.length-1]),e},getStartValue:function(){return this.init.start}},countBoolTrueAgg:{type:"int",init:{start:0},add:function(e,t){return e||(e={value:this.init.start}),!0===t&&(e.value=e.value+1),e},remove:function(e,t){return e||(e={value:this.init.start}),!0!==t||0===e.value||(e.value=e.value-1),e},getStartValue:function(){return this.init.start}}};return t.aggregates=r,t}([u],{}),a,s,c],{}),v=(n=!0,r=!1,i=!1,"undefined"!=typeof navigator&&(n=void 0===navigator.onLine||navigator.onLine,window.addEventListener("online",(function(){n=!0})),window.addEventListener("offline",(function(){n=!1}))),{get isOnline(){return!r&&n},get isRealOnline(){return n},set isOnline(e){n=e},get isOfflineMode(){return r},set isOfflineMode(e){r=e},get isSynchronizing(){return i},set isSynchronizing(e){i=e}}),h=function(e,t){var n=e[0],r=e[1],i=e[2],o=i.queue;function a(e,t,n,o){if(n&&n.length)return e.isStoreObject&&(n=n[0]),n=i.cloneAndFreeze(n,e.clone),r.pushToHandlers(e,t,n,o);o()}return t.beforeAction=function(e,t,r){n.checkArgs(e,t,r);var i=n.getStore(e),o=n.getCollection(i);return r||(t=i.clone(t)),{value:t,store:i,collection:o}},t.afterAction=function(e,t,n,o,a){var s=null;n&&(s=i.cloneAndFreeze(n,e.clone)),r.pushToHandlers(e,t,s,(function(){if(o)return r.pushToHandlers(e,"success",o,a);a()}))},t.pushCommitResToHandlers=a,t.propagate=function(e,t,r,s){return e.storesToPropagate.length?!t&&r!==i.OPERATIONS.DELETE||t&&Array.isArray(t)&&!t.length?s():void o(e.storesToPropagate,(function(i,o){var s=n.getStore("@"+i);a(s,"update",n.getCollection(s).propagate(e.name,t,r),o)}),s):s()},t.propagateReferences=function(e,t,r){if(!e.storesToPropagateReferences||!e.storesToPropagateReferences.length)return r();o(e.storesToPropagateReferences,(function(r,i){for(var o=n.getStore("@"+r),s=n.getCollection(o),l=[],u=0;u<t.length;u++)l=l.concat(s.replaceReferences(e.name,t[u][0],t[u][1]));a(o,"update",l,i)}),r)},t}([f,l,u],{}),p=function(e,t){var n=e[0],r=e[1].indexedDB,i=e[2].cacheGraph,o=e[3];Array.prototype.equals=function(e){if(!e)return!1;if(this.length!==e.length)return!1;for(var t=0,n=this.length;t<n;t++)if(this[t]instanceof Array&&e[t]instanceof Array){if(!this[t].equals(e[t]))return!1}else if(this[t]!==e[t])return!1;return!0};var a=[];function s(e,t,n){for(var i=null,s=0;s<a.length;s++){var l=!1;if(a[s].hash===t){l=!0,i=a[s];break}}return l&&!n?i.values:l&&n?(-1===i.stores.indexOf(e)&&(i.stores.push(e),o.isOnline&&r.upsert("cache",i)),i.values=n):i}function l(e){for(var t=a.length-1;t>=0;t--)-1!==a[t].stores.indexOf(e)&&(r.del("cache",a[t].hash),a.splice(t,1))}return{init:function(e){r.getAll("cache",(function(t,r){t&&n.warn("Error when init cache",t),a=r||[],e()}))},add:function(e,t,n){if(!s(e,t,n)){var i={hash:t,values:n,stores:[e]};a.push(i),o.isOnline&&r.upsert("cache",i)}},get:s,invalidate:function(e){l(e=e.replace(/^@/,""));var t=i[e];if(t)for(var n=0;n<t.length;n++)l(t[n])},clear:function(){r.clear("cache"),a=[]},_cache:function(){return a}}}([s,c,a,v]),g=(o=[a,s][1],{begin:function(){return o.deprecated("lunaris.begin has been removed!")},commit:function(e){return o.deprecated("lunaris.commit has been removed!")}}),m=function(e,t){var n=e[0],r=e[1],i={onComplete:null};return t.request=function(e,t,r,o,a){var s=r,l={"Client-Version":2};a=a||{},l["Content-Type"]=a["Content-Type"]||"application/json",a.isOffline&&(l["Is-Offline"]=a.isOffline),"application/json"===l["Content-Type"]&&r&&(s=JSON.stringify(r),n.isProduction&&(l["Content-Encoding"]="gzip",s=pako.gzip(s))),fetch(n.baseUrl+t,{method:e,credentials:"same-origin",headers:l,body:s}).then((function(e){return 200!==e.status?Promise.reject({error:e.status,message:e.statusText,errors:[]}):(window.origin||(window.origin=""),-1===decodeURIComponent(e.url).indexOf(decodeURIComponent(t))?window.location=e.url:(i.onComplete&&i.onComplete(e),e.json()))})).then((function(e){if(!1===e.success)return o({error:e.error,message:e.message,errors:e.errors});o(null,e.data)})).catch((function(e){o(e)}))},t.setup=function(e){i=r.merge(i,e)},t}([a,u],{}),b=function(e,t){var n=e[0],r=e[1],i=e[2],o=e[3],a=e[4];function s(e){return encodeURIComponent(e).replace(/[!'()*]/g,(function(e){return"%"+e.charCodeAt(0).toString(16)}))}function l(e,t){if("function"!=typeof e)return i.tip("A filter where must be a function : filter.sourceWhere = function (item) { return Boolean }."),!1;var n=e.call(null,t,o.constants);return"boolean"!=typeof n?(i.tip("A filter where must return a boolean."),!1):n}function u(e){for(var t="",n=r.OPERATORS,i=0;i<e.length;i++){var o=r.OPERATORS.ILIKE;e[i][3]&&(o=n[e[i][3]]||o);var a=e[i][2];Array.isArray(a)&&(a="["+a.join(",")+"]",o===r.OPERATORS["="]&&(o=r.OPERATORS.ILIKE),o===r.OPERATORS["<>"]&&(o=":!")),t+=(e[i][0]||e[i][1])+s(o)+s(a)+s("+")}return["search",t=t.slice(0,t.length-s("+").length)]}return t.create=function(e,t,o,c){var f={request:"/",cache:{}},d="GET"===t&&!1!==c,v=e.url||e.name;f.request+=v,null!=o&&(f.request+="/"+o),d&&(f.cache.limit=e.paginationLimit,f.cache.offset=e.paginationOffset);var h=function(e,t){var r={isRequiredOptionsFilled:!0,constructedRequiredOptions:"",requiredOptions:{},optionalOptions:{},optionalUnsearchableOptions:{},cache:{}},i=0,o=0;if(!e.filters.length)return r;for(var u=0;u<e.filters.length;u++){var c=e.filters[u],f=[];if(a.isOnline||!1!==c.isOffline){var d=n.getStore(c.source),v=n.getCollection(d).getAll();v&&!Array.isArray(v)?v=[v]:v||(v=[]);var h=[];c.httpMethods?Array.isArray(c.httpMethods)&&(h=c.httpMethods):h.push(t),c.isRequired&&-1!==h.indexOf(t)&&i++;for(var p=c.operator,g=v.length-1;g>=0;g--)!c.sourceWhere||c.sourceWhere&&l(c.sourceWhere,v[g])?v[g]=v[g][c.sourceAttribute]:v.splice(g,1);if(v.length||(v=void 0),d.isStoreObject&&(v=v?v[0]:void 0),void 0!==v){var m=u;if(f.push(c.attributeUrl,c.localAttribute,v,p),-1!==h.indexOf(t)){if(c.isRequired&&o++,!1===c.isSearchable)r.optionalUnsearchableOptions[m]=f;else if(f[3]&&!c.isRequired)r.optionalOptions[m]=f;else{if(Array.isArray(v))throw new Error("A required filter must be a store object!");r.constructedRequiredOptions+="/"+(f[0]||f[1])+"/"+s(f[2]),r.requiredOptions[m]=f}r.cache[m]=f[2]}}}}return r.isRequiredOptionsFilled=i===o,r}(e,t);return h.isRequiredOptionsFilled?(f.request+=h.constructedRequiredOptions,e.urlSuffix&&(f.request+="/"+e.urlSuffix,i.deprecated("store.urlSuffix is deprecated. It will be removed!")),f.request+=function(e,t,n){var r="",i=[];if(t){var o=e.paginationLimit,a=e.paginationOffset;i.push(["limit",o]),i.push(["offset",a])}for(var l,c,f=Object.keys(n.optionalUnsearchableOptions),d=0;d<f.length;d++)i.push((l=n.optionalUnsearchableOptions[f[d]],c=void 0,c=l[2],Array.isArray(c)&&(c="["+c.join(",")+"]"),c=s(c),[l[0]||l[1],c]));var v=[];for(f=Object.keys(n.optionalOptions),d=0;d<f.length;d++)v.push(n.optionalOptions[f[d]]);for(v.length&&i.push(u(v)),i.length&&(r+="?"),d=0;d<i.length;d++)r+=i[d][0]+"="+i[d][1]+"&";return r=r.slice(0,r.length-1)}(e,d,h),r.merge(f.cache,h.cache),f.requiredOptions=h.requiredOptions,f.optionalOptions=h.optionalOptions,f.constructedRequiredOptions=h.constructedRequiredOptions,f):null},t.createForOffline=function(e,t){var n="/";n+=e.url||e.name,n+=t.constructedRequiredOptions;for(var r=[],i=Object.keys(t.optionalOptions),o=0;o<i.length;o++)r.push(t.optionalOptions[i[o]]);var a=u(r);return n+="?limit="+t.cache.limit+"&offset="+t.cache.offset+"&"+a[0]+"="+a[1]},t}([f,u,s,a,v],{}),y=function(e,t){function n(e,t,n,r,i){return r.replace("$methodFemale",n).replace("$method",t).replace("$storeName",e.nameTranslated||e.name).replace("$pronounMale",i?"${thePlural}":"${the}").replace("$pronounFemale",i?"${thePlural}":"${theFemale}")}return t.getSuccess=function(e,t,r,i){return t.successTemplate?n(t,{GET:"${loaded}",PUT:"${edited}",POST:"${created}",DELETE:"${deleted}"}[r],{GET:"${loadedFemale}",PUT:"${editedFemale}",POST:"${createdFemale}",DELETE:"${deletedFemale}"}[r],t.successTemplate,i):e},t.getError=function(e,t,r,i,o){return t.errorTemplate?n(t,{GET:"${load}",PUT:"${edit}",POST:"${create}",DELETE:"${delete}"}[r],{GET:"${loadFemale}",PUT:"${editFemale}",POST:"${createFemale}",DELETE:"${deleteFemale}"}[r],t.errorTemplate,i):"${An error has occured}"},t}(0,{}),O=function(e,t){var n=e[0],r=e[1],i=e[2],o=e[3],a=e[4],s=(e[5],e[6]),l=e[7].indexedDB,u=e[8].localStorage,c=i.OPERATIONS,f=[],d=[],v=i.offlineStore,h=!1;e={};function p(e,t){var n=o.getCollection(o.getStore(e));if(n)return n.get(t)}function g(e,t,n,r,i){var o=!0,a=Array.isArray(i);a||(i=[i]);for(var s=i.length,l=0,u=s-1;u>=0;u--)for(var f=e.length-1;f>=0;f--){var d=e[f],v=Array.isArray(d.data);v||(d.data=[d.data]);var h=d.data.length;if(d.store===t){for(var p=h-1;p>=0;p--){if(d.method===c.INSERT&&n===c.UPDATE){if(i[u]._id!==d.data[p]._id)continue;d.data[p]=i[u],i.splice(u,1),l++,u||l!==s||(o=!1);break}if(d.method===c.UPDATE&&n===c.UPDATE){if(i[u]._id!==d.data[p]._id)continue;d.data[p]=i[u],o=!1;break}}if(v||(d.data=d.data[0]),!i[u])break}else v||(d.data=d.data[0])}return o&&e.push({store:t,method:n,url:r,data:a?i:i[0],date:Date.now()}),e}return n._stores.lunarisOfflineTransactions={name:v,data:a.collection(null,null,null,null,null,v,null,i.clone),filters:[],paginationLimit:50,paginationOffset:0,paginationCurrentPage:1,hooks:{},isLocal:!0,storesToPropagate:[],isStoreObject:!1,massOperations:{},clone:i.clone},{get isPushingOfflineTransaction(){return h},OFFLINE_STORE:v,updateOfflineTransactionData:function(e){var t=e.length;if(t)for(var n=0,r=f.length;n<r;n++)for(var i=f[n],o=0;o<t;o++)if(i.store===e[o]&&-1!==e.indexOf(i.store))if(Array.isArray(i.data))for(var a=0;a<i.data.length;a++)i.data[a]=p(e[o],i.data[a]._id);else i.data=p(e[o],i.data._id)},pushOfflineHttpTransactions:function(t){f=n._stores.lunarisOfflineTransactions.data.getAll(),h=!0,function a(){var p=f.shift();if(!p)return h=!1,function(){for(var e=n._stores.lunarisOfflineTransactions.data,t=e.begin(),r=0;r<d.length;r++)e.remove(i.clone(d[r]),t),delete d[r]._id,d[r].isInError=!0,e.add(d[r],t);e.commit(t),d=[],o.saveState(n._stores.lunarisOfflineTransactions,e)}(),u.set(v,new Date),t();function g(e){s.invalidate(p.store),e?(d.push(p),p.method===c.INSERT&&function(e){var t=e.length;if(t)for(var n=f.length-1;n>=0;n--)for(var r=f[n],i=0;i<t;i++)r.store===e[i]&&-1!==e.indexOf(r.store)&&(l.del(v,r._id),d.splice(1,0,f.splice(n,1)[0]))}(o.getStore(p.store).storesToPropagateReferences),r.pushToHandlers(n._stores.lunarisOfflineTransactions,"syncError")):r.pushToHandlers(n._stores.lunarisOfflineTransactions,"syncSuccess"),n._stores.lunarisOfflineTransactions.data.remove(p),r.pushToHandlers(n._stores.lunarisOfflineTransactions,"delete",p),a()}p.method===c.INSERT||p.method===c.UPDATE?e.upsert(p.store,p.data,{isLocal:!1,retryOptions:p},g):p.method===c.DELETE&&e.deleteStore(p.store,p.data,{retryOptions:p},g)}()},computeStoreTransactions:g,setOfflineHttpTransaction:function(t,i,a,s){var l=n._stores.lunarisOfflineTransactions.data,u=l.getAll();e._clear(v,!0),g(u,t,i,a,s);for(var c=l.begin(),f=0;f<u.length;f++)delete u[f]._id,l.add(u[f],c);l.commit(c),o.saveState(n._stores.lunarisOfflineTransactions,l),r.pushToHandlers(n._stores.lunarisOfflineTransactions,"insert")},getLastSyncDate:function(){return u.get(v)},setImportFunction:function(t){e[t.name]=t}}}([a,l,u,f,d,g,p,c,c]),A=function(e,t){var n=e[0],r=e[1].indexedDB,i=e[2],o=e[3];function a(e,t){!function(e,t){var r=[];r=r.concat(e.storesToPropagate||[]).concat(e.storesToPropagateReferences||[]),n.queue(r,(function(e,t){try{var n=o.getStore("@"+e)}catch(e){return t()}if(n.isInitialized)return t();s(n,[t,null])}),t)}(e,(function(){t[0].apply(null,t[1])}))}function s(e,t,o){if(!i.isBrowser)return e.isInitialized=!0,a(e,t);r.get("_states",e.name,(function(i,l){return i?o?(lunaris.warn("lazy_load@"+e.name,i),a(e,t)):(e.isInitialized=!0,s(e,t,!0)):l?(e.data.setCurrentId(l.collection.currentId),e.data.setCurrentRowId(l.collection.currentRowId),e.massOperations=l.massOperations,void r.getAll(e.name,(function(r,i){if(r)return o?(lunaris.logger.warn(["lazy_load@"+e.name,"Error when retrieving store collection"],r),a(e,t)):(e.isInitialized=!0,s(e,t,!0));n.deleteRows(i),e.data.setData(i),e.isInitialized=!0,a(e,t)}))):(e.isInitialized=!0,a(e,t))}))}return t.load=s,t}([u,c,a,f],{}),T=function(e,t){var n=e[0],r=e[1],i=e[2],o=e[3],a=e[4],s=(e[5],e[6]),l=e[7],u=e[8],c=e[9],f=e[10],d=e[11],v=e[12],h=i.OPERATIONS;e={};function p(e,t){return e.removeIndexIdValue(t._id)}function g(e,t,n,i,s,u,f,v,h,p,g){var m=n;if(f.length){e.massOperations[f.join(".")]=n;var b=t.getAll();i=t.begin();for(var y=0;y<b.length;y++)o.setPathValue(f,n,b[y]),t.upsert(b[y],i)}else if(i=t.begin(),s)for(y=0;y<n.length;y++)o.setObjectPathValues(e.massOperations,n[y]),t.upsert(n[y],i);else{if(e.isStoreObject){var O=t.getAll(),A=O?O._id:null;n._id=A}a.isOnline||u||o.setPrimaryKeyValue(e,n,e.isStoreObject?n._id:t.getCurrentId()),o.setObjectPathValues(e.massOperations,n),t.upsert(n,i)}if(n=t.commit(i),s&&!a.isOnline&&!u){for(i=t.begin(),y=0;y<n.length;y++)o.setPrimaryKeyValue(e,n[y],n[y]._id),t.upsert(n[y],i);n=t.commit(i)}r.invalidate(e.name);var T=n;if(s||e.isStoreObject||(T=T[0]),f.length&&(m={op:"replace",path:o.getJSONPatchPath(f.join(".")),value:m},T=m),!(v=c.create(e,h,o.getPrimaryKeyValue(e,T,!u||u&&s))))return g("No url. Maybe the required filters are not set");v=v.request,a.isOnline||e.isLocal||p||d.setOfflineHttpTransaction(e.name,h,v,s||e.isStoreObject?n:n[0]),l.propagate(e,n,h,(function(){l.afterAction(e,u?"update":"insert",n,null,(function(){o.saveState(e,t,(function(){g(null,{version:i,value:T,request:v})}))}))}))}function m(e,t,n,r,a,u){l.propagate(e,n,i.OPERATIONS.UPDATE,(function(){l.afterAction(e,"update",n,null,(function(){l.afterAction(e,r?"updated":"inserted",n,f.getSuccess(null,e,a,!1),(function(){o.saveState(e,t,(function(){if(e.isFilter)return s.pushToHandlers(e,"filterUpdated",null,u);u(null,n)}))}))}))}))}function b(e,t,r,a,c,v,g,b,y){u.request(e,t,v,(function(u,O){if(u){var A=f.getError(u,a,e,!1);return T(a.name,e,t,v,b,u,A),n.warn(["lunaris."+(r?"update":"insert")+"@"+a.name],u),s.pushToHandlers(a,"errorHttp",{error:A,data:i.cloneAndFreeze(v)},(function(){y(u)}))}if(e===h.PATCH)return l.afterAction(a,"patched",null,y);var w=!0,E=[];if(a.isStoreObject||!g){if(a.isStoreObject&&Array.isArray(O))return y('The store "'+a.name+'" is a store object. The '+e+" method tries to "+(r?"update":"insert")+" multiple elements!");Array.isArray(O)&&(O=O[0]),v=i.merge(v,O);var S=c.begin();c.upsert(v,S),d.isPushingOfflineTransaction&&e===h.INSERT&&(p(c,v),E.push(["_"+v._id,o.getPrimaryKeyValue(a,v)])),(v=c.commit(S))||(w=!1)}else{var _=Array.isArray(O);S=c.begin();for(var I=0;I<v.length;I++)if(_)for(var P=0;P<O.length;P++)v[I]._id===O[P]._id&&(v[I]=i.merge(a.clone(v[I]),O[P]),c.upsert(v[I],S),d.isPushingOfflineTransaction&&e===h.INSERT&&(p(c,v[I]),E.push(["_"+v[I]._id,o.getPrimaryKeyValue(a,v[I])])));else v[I]=i.merge(v[I],O),c.upsert(v[I],S),d.isPushingOfflineTransaction&&e===h.INSERT&&(p(c,v[I]),E.push(["_"+v[I]._id,o.getPrimaryKeyValue(a,v[I])]));v=c.commit(S)}return d.isPushingOfflineTransaction&&e===h.INSERT?l.propagateReferences(a,E,(function(){if(d.updateOfflineTransactionData(a.storesToPropagateReferences),!w)return y();m(a,c,v,r,e,y)})):w?void m(a,c,v,r,e,y):y()}))}function y(e,t,n,r,o){if(e.isLocal||r)return e.isFilter?l.propagate(e,t,n?i.OPERATIONS.UPDATE:i.OPERATIONS.INSERT,(function(){s.pushToHandlers(e,"filterUpdated",null,o)})):l.propagate(e,t,n?i.OPERATIONS.UPDATE:i.OPERATIONS.INSERT,o);o()}function O(e,t,n,r,i,o,s){if(!e.isInitialized)return v.load(e,[O,arguments]);var l,u=Array.isArray(r),c="/";o.retryOptions&&(c=o.retryOptions.url);var f=h.UPDATE;return i||(f=h.INSERT),n.length&&(f=h.PATCH),o.retryOptions?(l=o.retryOptions.version,a.isOnline?void b(f,c,i,e,t,r,u,l,s):s(null,r)):g(e,t,r,l,u,i,n,c,f,o.isLocal,(function(n,d){if(n)return s(n);l=d.version,r=d.value,c=d.request,y(e,r,i,o.isLocal,(function(){if(e.isLocal||o.isLocal||!a.isOnline)return s(null,r);b(f,c,i,e,t,r,u,l,s)}))}))}function A(t,r,i,o){"function"==typeof i&&(o=i,i={}),i||(i={}),o=o||function(){};var a=!1,s=t&&"string"==typeof t?t.split(":"):[];s.length&&(t=s.shift()),s.length&&(a=!0);var u="lunaris."+(a?"update":"insert")+t;try{i.retryOptions&&(r=i.retryOptions.data);var c=l.beforeAction(t,r);if((Array.isArray(r)&&null!==r[0]._id&&void 0!==r[0]._id||null!==r._id&&void 0!==r._id)&&(a=!0),i.retryOptions&&i.retryOptions.method===h.INSERT&&(a=!1),c.store.validateFn&&!s.length&&!i.retryOptions)return e.validate(t,c.value,a,(function(e){if(!e)return o("Error when validating data");O(c.store,c.collection,s,c.value,a,i,(function(e,t){if(e)throw o(e),e;o(null,t)}))}),u);O(c.store,c.collection,s,c.value,a,i,(function(e,t){if(e)throw o(e),e;o(null,t)}))}catch(e){n.warn([u],e)}}function T(e,t,n,r,i,o,a){A("@lunarisErrors",{version:i,data:r,url:n,method:t,storeName:e,date:dayjs(),messageError:a,messageErrorServer:o})}return d.setImportFunction(A),t.upsert=A,t.setLunarisError=T,t.setImportFunction=function(t){e[t.name]=t},t}([s,p,u,f,v,g,l,h,m,b,y,O,A],{}),w=function(e,t){var n=0;function r(e){for(var t=Array(e.length>>2),n=0;n<t.length;n++)t[n]=0;for(n=0;n<8*e.length;n+=8)t[n>>5]|=(255&e.charCodeAt(n/8))<<n%32;return t}function i(e){for(var t="",n=0;n<32*e.length;n+=8)t+=String.fromCharCode(e[n>>5]>>>n%32&255);return t}function o(e,t){e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;for(var n=1732584193,r=-271733879,i=-1732584194,o=271733878,a=0;a<e.length;a+=16){var d=n,v=r,h=i,p=o;n=s(n,r,i,o,e[a+0],7,-680876936),o=s(o,n,r,i,e[a+1],12,-389564586),i=s(i,o,n,r,e[a+2],17,606105819),r=s(r,i,o,n,e[a+3],22,-1044525330),n=s(n,r,i,o,e[a+4],7,-176418897),o=s(o,n,r,i,e[a+5],12,1200080426),i=s(i,o,n,r,e[a+6],17,-1473231341),r=s(r,i,o,n,e[a+7],22,-45705983),n=s(n,r,i,o,e[a+8],7,1770035416),o=s(o,n,r,i,e[a+9],12,-1958414417),i=s(i,o,n,r,e[a+10],17,-42063),r=s(r,i,o,n,e[a+11],22,-1990404162),n=s(n,r,i,o,e[a+12],7,1804603682),o=s(o,n,r,i,e[a+13],12,-40341101),i=s(i,o,n,r,e[a+14],17,-1502002290),n=l(n,r=s(r,i,o,n,e[a+15],22,1236535329),i,o,e[a+1],5,-165796510),o=l(o,n,r,i,e[a+6],9,-1069501632),i=l(i,o,n,r,e[a+11],14,643717713),r=l(r,i,o,n,e[a+0],20,-373897302),n=l(n,r,i,o,e[a+5],5,-701558691),o=l(o,n,r,i,e[a+10],9,38016083),i=l(i,o,n,r,e[a+15],14,-660478335),r=l(r,i,o,n,e[a+4],20,-405537848),n=l(n,r,i,o,e[a+9],5,568446438),o=l(o,n,r,i,e[a+14],9,-1019803690),i=l(i,o,n,r,e[a+3],14,-187363961),r=l(r,i,o,n,e[a+8],20,1163531501),n=l(n,r,i,o,e[a+13],5,-1444681467),o=l(o,n,r,i,e[a+2],9,-51403784),i=l(i,o,n,r,e[a+7],14,1735328473),n=u(n,r=l(r,i,o,n,e[a+12],20,-1926607734),i,o,e[a+5],4,-378558),o=u(o,n,r,i,e[a+8],11,-2022574463),i=u(i,o,n,r,e[a+11],16,1839030562),r=u(r,i,o,n,e[a+14],23,-35309556),n=u(n,r,i,o,e[a+1],4,-1530992060),o=u(o,n,r,i,e[a+4],11,1272893353),i=u(i,o,n,r,e[a+7],16,-155497632),r=u(r,i,o,n,e[a+10],23,-1094730640),n=u(n,r,i,o,e[a+13],4,681279174),o=u(o,n,r,i,e[a+0],11,-358537222),i=u(i,o,n,r,e[a+3],16,-722521979),r=u(r,i,o,n,e[a+6],23,76029189),n=u(n,r,i,o,e[a+9],4,-640364487),o=u(o,n,r,i,e[a+12],11,-421815835),i=u(i,o,n,r,e[a+15],16,530742520),n=c(n,r=u(r,i,o,n,e[a+2],23,-995338651),i,o,e[a+0],6,-198630844),o=c(o,n,r,i,e[a+7],10,1126891415),i=c(i,o,n,r,e[a+14],15,-1416354905),r=c(r,i,o,n,e[a+5],21,-57434055),n=c(n,r,i,o,e[a+12],6,1700485571),o=c(o,n,r,i,e[a+3],10,-1894986606),i=c(i,o,n,r,e[a+10],15,-1051523),r=c(r,i,o,n,e[a+1],21,-2054922799),n=c(n,r,i,o,e[a+8],6,1873313359),o=c(o,n,r,i,e[a+15],10,-30611744),i=c(i,o,n,r,e[a+6],15,-1560198380),r=c(r,i,o,n,e[a+13],21,1309151649),n=c(n,r,i,o,e[a+4],6,-145523070),o=c(o,n,r,i,e[a+11],10,-1120210379),i=c(i,o,n,r,e[a+2],15,718787259),r=c(r,i,o,n,e[a+9],21,-343485551),n=f(n,d),r=f(r,v),i=f(i,h),o=f(o,p)}return Array(n,r,i,o)}function a(e,t,n,r,i,o){return f((a=f(f(t,e),f(r,o)))<<(s=i)|a>>>32-s,n);var a,s}function s(e,t,n,r,i,o,s){return a(t&n|~t&r,e,t,i,o,s)}function l(e,t,n,r,i,o,s){return a(t&r|n&~r,e,t,i,o,s)}function u(e,t,n,r,i,o,s){return a(t^n^r,e,t,i,o,s)}function c(e,t,n,r,i,o,s){return a(n^(t|~r),e,t,i,o,s)}function f(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n}return function(e){return function(e){for(var t,r=n?"0123456789ABCDEF":"0123456789abcdef",i="",o=0;o<e.length;o++)t=e.charCodeAt(o),i+=r.charAt(t>>>4&15)+r.charAt(15&t);return i}(function(e){return i(o(r(e),8*e.length))}(function(e){var t,n,r="",i=-1;for(;++i<e.length;)t=e.charCodeAt(i),n=i+1<e.length?e.charCodeAt(i+1):0,55296<=t&&t<=56319&&56320<=n&&n<=57343&&(t=65536+((1023&t)<<10)+(1023&n),i++),t<=127?r+=String.fromCharCode(t):t<=2047?r+=String.fromCharCode(192|t>>>6&31,128|63&t):t<=65535?r+=String.fromCharCode(224|t>>>12&15,128|t>>>6&63,128|63&t):t<=2097151&&(r+=String.fromCharCode(240|t>>>18&7,128|t>>>12&63,128|t>>>6&63,128|63&t));return r}(e)))}}(),E=function(e,t){var n=e[0],r=n.OPERATORS,i=e[1],o=e[2],a=e[3];function s(e,t){var n=t(e);return delete n._id,delete n._version,delete n._rowId,n}function l(e,t){for(var r=t.split(" "),i=0;i<e.length;i++)for(var o=0,a=0;a<e[i].length;a++)for(var s=0;s<r.length;s++){if(-1!==n.unaccent(r[s]).toLowerCase().indexOf(e[i][a])&&++o>=e[i].length)return!0}return!1}function u(e,t,i,o){if(!e&&t[3]!==r.ILIKE||!t)return i;var a=t[2];if("ILIKE"===t[3]&&!o){Array.isArray(a)||(a=[a]);for(var s=[],u=0;u<a.length;u++)a[u]=n.unaccent(a[u]),s.push(a[u].toLowerCase().split(" "));a=s}for(var c=[],f=0,d=i.length;f<d;f++)e.call(null,a,i[f],l)&&c.push(i[f]);return c}return t.filter=function(e,t,n){var r=t.getAll(null,!1,!1);if(!n||!e.filterFns)return r;e.isStoreObject&&(r=[r]);for(var l=Object.keys(n.requiredOptions),c=0;c<l.length;c++)void 0!==e.filterFns[l[c]]&&(r=u(e.filterFns[l[c]],n.requiredOptions[l[c]],r,!0));var f=Object.keys(n.optionalOptions);for(c=0;c<f.length;c++)void 0!==e.filterFns[f[c]]&&(r=u(e.filterFns[f[c]],n.optionalOptions[f[c]],r,!1));return e.isStoreObject?r=r[0]||null:function(e,t,n){for(var r=n.length,l=[],u=0;u<r&&u<e.paginationLimit;u++)l.push(s(n[u],e.clone));if(t.cache.offset=0,t.cache.limit=e.paginationLimit,i.add(e.name,o(a.createForOffline(e,t)),l),r<=e.paginationLimit)return n;var c=n.slice(0,e.paginationLimit);l=[];for(var f=0,d=e.paginationLimit;d<r;d++)f++,l.push(s(n[d],e.clone)),f%e.paginationLimit&&d+1!==r||(t.cache.offset+=e.paginationLimit,i.add(e.name,o(a.createForOffline(e,t)),l),l=[]);return c}(e,n,r)},t.ilike=l,t}([u,p,w,b],{}),S=function(e,t){var n=e[0],r=e[1],i=e[2],o=e[3],a=e[4],s=e[5],l=e[6],u=e[7],c=e[8],f=e[9],d=e[10],v=e[11],h=(e[12].indexedDB,{});function p(e,t,n,r,a){try{var l=n;i.checkArgs(e,t,!0),r||(r=n,l=!1,(Array.isArray(t)&&t[0]._id||t._id)&&(l=!0));var u=i.getStore(e);if(u.validateFn){var c=t;if(u.isStoreObject&&Array.isArray(t))throw new Error('The store "'+e.name+'" is a store object, you cannot add or update multiple elements!');u.isStoreObject||Array.isArray(t)||(c=[t]);var f=!!s.isOnline&&l;return u.validateFn(c,u.onValidate,f,(function(t){if(t.length){for(var n=0;n<t.length;n++)o.warn(["lunaris."+(l?"update":"insert")+e+" Error when validating data"],t[n]);return r(!1,t)}r(!0)}))}throw new Error("The store does not have a map! You cannot validate a store without a map.")}catch(t){o.warn([a||"lunaris.validate"+e],t)}}return n._stores.lunarisErrors={name:"lunarisErrors",data:a.collection(null,!1,null,null,null,"lunarisErrors",null,r.clone),filters:[],paginationLimit:50,paginationOffset:0,paginationCurrentPage:1,hooks:{},nameTranslated:"${store.lunarisErrors}",isLocal:!0,storesToPropagate:[],isStoreObject:!1,massOperations:{},clone:r.clone},u.setImportFunction(p),t.get=c.get,t.load=c.load,t.getOne=function(e,t,n){try{var i,a=l.beforeAction(e,null,!0);if(!(i=t?a.collection.get(t,n):a.collection.getFirst()))return;return r.cloneAndFreeze(i)}catch(t){o.warn(["lunaris.getOne"+e],t)}},t.insert=u.upsert,t.update=u.upsert,t.upsert=u.upsert,t.delete=d.delete,t.clear=f.clear,t.rollback=function(e,t){try{l.beforeAction(e,null,!0).collection.rollback(t)}catch(t){o.warn(["lunaris.rollback"+e],t)}},t.getDefaultValue=function(e){try{var t=l.beforeAction(e,null,!0);return t.store.defaultValue?r.clone(t.store.defaultValue):h}catch(t){o.warn(["lunaris.getDefaultValue"+e],t)}},t.validate=p,t.setPagination=function(e,t,n){try{var r=l.beforeAction(e,null,!0);r.store.paginationLimit=n||r.store.paginationLimit,r.store.paginationCurrentPage=t||1,r.store.paginationOffset=r.store.paginationLimit*r.store.paginationCurrentPage-r.store.paginationLimit,i.saveState(r.store,r.collection)}catch(t){o.warn(["lunaris.setPagination"+e],t)}},t.createUrl=function(e,t,n){try{var r=l.beforeAction(e,null,!0);if(!t)throw new Error("Must provide a method, ex: GET, POST, etc.");var i=v.create(r.store,t,n);return i?i.request:void 0}catch(e){o.warn(["lunaris.createUrl"],e)}},t}([a,u,f,s,d,v,h,T,function(e,t){var n=e[0],r=e[1],i=e[2],o=e[3],a=e[4],s=e[5],l=e[6],u=e[7],c=e[8],f=e[9],d=e[10],v=e[11],h=e[12],p=e[13].indexedDB,g=e[14],m={};l.OPERATIONS;function b(e){var t=m[e].shift();t&&(t=t.concat([b]),T.apply(null,t))}function y(e,t,n,r,i,o){var a=[];return"object"==typeof r&&(u.saveState(e,t),a=function(e,t){var n=e.begin();if(Array.isArray(t))for(var r=0;r<t.length;r++)e.add(t[r],n);else e.add(t,n);return e.commit(n)}(t,e.clone(r))),c.afterAction(e,"get",a,null,(function(){if(e.isFilter)return d.pushToHandlers(e,"filterUpdated",null,(function(){i.callback(null,a),o("@"+e.name)}));i.callback(null,a),o("@"+e.name)}))}function O(e,t,r,i,o){var a=n.filter(e,t,r);c.afterAction(e,"get",a,null,(function(){if(e.isFilter&&(e.isStoreObject&&a||!e.isStoreObject&&a.length))return d.pushToHandlers(e,"filterUpdated",null,(function(){u.saveState(e,t,(function(){i.callback(null,a),o("@"+e.name)}))}));u.saveState(e,t,(function(){i.callback(null,a),o("@"+e.name)}))}))}function A(e,t,n,s,f,p){i.request("GET",n,null,(function(i,g){if(i){var m=v.getError(i,e,"GET",!0);return h.setLunarisError(e.name,"GET",n,null,null,i,m),o.warn(["lunaris.get@"+e.name],i),d.pushToHandlers(e,"errorHttp",{error:m},(function(){f.callback(i),p("@"+e.name)}))}var b=t.begin();if(Array.isArray(g)){if(e.isStoreObject)return i='The store "'+e.name+'" is an object store. The GET method cannot return multiple elements!',o.warn(["lunaris.get@"+e.name],new Error(i)),f.callback(i),p("@"+e.name);a.add(e.name,r(n),e.clone(g));for(var y=0;y<g.length;y++)t.upsert(g[y],b);s&&g.length&&(g=g[0])}else a.add(e.name,r(n),e.clone(g)),t.upsert(g,b);g=t.commit(b),c.propagate(e,g,l.OPERATIONS.INSERT,(function(){c.afterAction(e,"get",g,null,(function(){if(e.isFilter)return d.pushToHandlers(e,"filterUpdated",null,(function(){u.saveState(e,t,(function(){f.callback(null,g),p("@"+e.name)}))}));u.saveState(e,t,(function(){f.callback(null,g),p("@"+e.name)}))}))}))}),{store:e.name})}function T(e,t,n,i){try{var l=c.beforeAction(e,null,!0);if(!l.store.isInitialized)return g.load(l.store,[T,arguments]);var u="/";if(u=s.create(l.store,"GET",t),l.store.paginationOffset=l.store.paginationLimit*l.store.paginationCurrentPage,l.store.paginationCurrentPage++,!u)return n.callback("No url. Maybe the required filters are not set"),i(e);var d=a.get(e.name,r(u.request));if(d)return y(l.store,l.collection,u.request,d,n,i);if(!f.isOnline||l.store.isLocal)return O(l.store,l.collection,u,n,i);A(l.store,l.collection,u.request,t,n,i)}catch(t){o.warn(["lunaris.get"+e],t)}}return t.get=function(e,t,n,r){m[e]||(m[e]=[]),"function"==typeof t&&(r=t,t=null),"function"==typeof n&&(r=n,n=null),"object"==typeof t&&(n=t,t=null),n||(n={}),n.callback=r||function(){},m[e].push([e,t,n]),1===m[e].length&&b(e)},t.load=function(e,t,n){"function"==typeof t&&(n=t,t=null),n||(n=function(){}),t||(t={});try{if(!f.isRealOnline)throw new Error("You are offline!");if(!f.isOfflineMode)throw new Error("Offline mode is not enabled!");var r=c.beforeAction(e,null,!0);if(r.store.isLocal)throw new Error("The store is local!");null==t&&(t={}),r.store.paginationCurrentPage=1,r.store.paginationOffset=0,r.store.paginationLimit=50,r.store.massOperations={},a.invalidate(r.store.name),r.collection.clear(),p.clear(r.store.name),u.saveState(r.store,r.collection,(function(){t.limit&&(r.store.paginationLimit=t.limit);var e=s.create(r.store,"GET",null,!!t.limit).request;i.request("GET",e,null,(function(t,i){if(t){var a=v.getError(t,r.store,"GET",!0);return h.setLunarisError(r.store.name,"GET",e,null,null,t,a),o.warn(["lunaris.load@"+r.store.name],t),d.pushToHandlers(r.store,"errorHttp",{error:a},(function(){n&&n()}))}Array.isArray(i)||(i=[i]);for(var s=r.collection.begin(),l=0,c=i.length;l<c;l++)r.collection.add(i[l],s);r.collection.commit(s),u.saveState(r.store,r.collection,(function(){d.pushToHandlers(r.store,"loaded",null,(function(){n&&n()}))}))}),{isOffline:!0,store:r.store.name})}))}catch(t){o.warn(["lunaris.load"+e],t)}},t}([E,w,m,s,p,b,u,f,h,v,l,y,T,c,A],{}),function(e,t){var n=e[0],r=e[1],i=e[2],o=e[3],a=e[4],s=e[5],l=e[6],u=e[7],c=e[8],f=e[9].indexedDB,d=i.OPERATIONS;function v(e,t,n){a.propagate(e,null,d.DELETE,(function(){o.saveState(e,t,n)}))}function h(e,t,n,r){if(!n)return v(e,t,(function(){l.pushToHandlers(e,"clear",null,(function(){l.pushToHandlers(e,"reset",null,r)}))}));v(e,t,r)}function p(e,t,i){try{var o=a.beforeAction(e,null,!0);if(o.store.paginationCurrentPage=1,o.store.paginationOffset=0,o.store.paginationLimit=50,o.store.massOperations={},r.invalidate(o.store.name),s.isOnline||o.store.isLocal)return o.collection.clear(),f.clear(o.store.name,(function(){h(o.store,o.collection,t.isSilent,i)}));h(o.store,o.collection,t.isSilent,i)}catch(t){i(t),n.warn(["lunaris.clear"+e],t)}}return c.setImportFunction(p),t.clear=function(e,t,r){if("function"==typeof t&&(r=t,t=null),"boolean"==typeof t&&(t={isSilent:t}),t||(t={}),t.isSilent=t.isSilent||!1,/\*$/.test(e)){if(!/^@/.test(e))return n.warn(["lunaris.clear"],new Error("The store key must begin by '@'"));var o=e.length-2,a=e.slice(1,o+1);return i.queue(Object.keys(u._stores),(function(e,n){if(e.slice(0,o)!==a)return n();p("@"+e,t,n)}),(function(){r&&r()}))}p(e,t,(function(e){r&&r(e)}))},t}([s,p,u,f,h,v,l,a,O,c],{}),function(e,t){var n=e[0],r=e[1],i=e[2],o=e[3],a=e[4],s=e[5],l=e[6],u=e[7],c=e[8],f=e[9],d=e[10],v=e[11],h=e[12],p=i.queue,g=i.OPERATIONS;function m(e,t,n,a,u){var c=t.begin();!function(e,t,n,r){if(!e.storesToPropagateReferences.length)return r();if(null==t.getIndexDataCache()[n._id])return r();var i=o.getPrimaryKeyValue(e,t.get(n._id));p(e.storesToPropagateReferences,(function(t,n){var a=o.getStore("@"+t),l=o.getCollection(a).getIndexReferences();if(!l[e.name])return n();if(!l[e.name][i])return n();var u="${Cannot delete the value, it is still referenced in the store} "+a.nameTranslated;s.pushToHandlers(e,"error",{error:u,data:null},(function(){r(!0)}))}),r)}(e,t,n,(function(s){if(s)return u(s);t.remove(n,c,!a),n=t.commit(c);var f=Array.isArray(n);if(a&&(!f&&!n||f&&!n.length))return u(new Error("You cannot delete a value not in the store!"));l.propagate(e,n,i.OPERATIONS.DELETE,(function(){l.afterAction(e,"delete",n,null,(function(){e.isStoreObject||(n=n[0]),r.invalidate(e.name),o.saveState(e,t,(function(){u(null,[c,n])}))}))}))}))}function b(e,t,r,i,h,p){if(e.isLocal||h.isLocal)return p(null,r);var b="/";if(h.retryOptions)b=h.retryOptions.url;else{if(!(b=c.create(e,"DELETE",o.getPrimaryKeyValue(e,r))))return p("No url. Maybe the required filters are not set");b=b.request}if(!a.isOnline)return d.setOfflineHttpTransaction(e.name,g.DELETE,b,r),p();u.request("DELETE",b,null,(function(o,a){if(o){var u=f.getError(o,e,"DELETE",!1);return v.setLunarisError(e.name,"DELETE",b,r,i,o,u),n.warn(["lunaris.delete@"+e.name],o),s.pushToHandlers(e,"errorHttp",{error:u,data:r},(function(){p(o)}))}m(e,t,a,!1,(function(t,n){if(t)return p(t);n[1]&&(r=n[1]),l.afterAction(e,"deleted",r,f.getSuccess(null,e,"DELETE",!1),(function(){p(null,r)}))}))}))}function y(e,t,r,i){"function"==typeof r&&(i=r,r={}),r||(r={}),i=i||function(){};try{r.retryOptions&&(t=r.retryOptions.data);var o,a=l.beforeAction(e,t);if(!a.store.isInitialized)return h.load(a.store,[y,arguments]);if(!r.retryOptions)return m(a.store,a.collection,t,!0,(function(e,n){if(e)throw i(e),e;o=n[0],t=n[1],b(a.store,a.collection,t,o,r,(function(e,t){if(e)throw i(e),e;i(null,t)}))}));o=r.retryOptions.version,b(a.store,a.collection,t,o,r,(function(e,t){if(e)throw i(e),e;i(null,t)}))}catch(t){n.warn(["lunaris.delete"+e],t)}}return d.setImportFunction(y),t.delete=y,t}([s,p,u,f,v,l,h,m,b,y,O,T,A],{}),b,c],{}),_=function(e,t){var n=e[0],r=e[2],i=null,o=200,a=null,s=!1,l={};function u(e){i||((i=new WebSocket(e)).onopen=function(){o=200,n.info("[Websocket]","Connected!"),c("invalidations")},i.onerror=function(e){},i.onclose=function(t){s||function(e){i=null,(o*=1.2)>2e4&&(o=2e4),n.info("[Websocket]","Reconnect to websocket server in "+o.toFixed(2)+"ms"),a=setTimeout((function(){r.isOnline||clearTimeout(a),u(e)}),o)}(e)},i.onmessage=function(e){if(e.data)try{var t=JSON.parse(e.data);l[t.channel]&&l[t.channel].call(null,t)}catch(e){n.warn("[Websocket] Cannot parse message incomming message",e)}})}function c(e,t){i.send(JSON.stringify({channel:e,data:t,ts:Date.now()}))}return e[1].isBrowser&&(window.onbeforeunload=function(){s=!0}),{_handlers:l,connect:u,send:function(e,t){c(e,t)},stop:function(e){i?(s=!0,i.onclose=function(){e&&e(),s=!1},i.close()):e&&e()},subscribe:(e,t)=>"function"!=typeof t?n.warn("[lunaris.websocket.subscribe] Handler is not a function"):"invalidated"!==e&&"invalidations"!==e||!l[e]?void(l[e]=t):n.warn("[lunaris.websocket.subscribe] Given channel is reserved"),unsubscribe(e){delete l[e]}}}([s,a,v]),I=function(e,t){var n=e[0].indexedDB,r=e[1],i=e[2],o=e[3],a=e[4],s=e[5],l={},u={},c="invalidate";return{invalidations:l,init:function(e){n.getAll("_invalidations",(function(t,n){if(t)return e();for(var r=0;r<n.length;r++)l[n[r].url]=n[r].date;e()}))},invalidate:function(e){if(/^GET\s/.test(e)){if(!r.urlsGraph[e])return;if(s.isOfflineMode&&!s.isSynchronizing)return void(u[c]&&u[c](e));d=e,v=Date.now(),l[d]=v,n.upsert("_invalidations",{url:d,date:v});for(var t=0,f=r.urlsGraph[e].length;t<f;t++)a.info("[Invalidate] "+e+" -> @"+r.urlsGraph[e][t]),o.clear("@"+r.urlsGraph[e][t])}else{var d,v;i.invalidate(e)}},computeInvalidations:function(e,t){var i=[],a=[];function s(e){if(r.urlsGraph[e]){var n=Date.now();l[e]=n,a.push({url:e,date:n});for(var i=0,s=r.urlsGraph[e].length;i<s;i++){var u=t.indexOf(r.urlsGraph[e][i]);-1!==u&&(o.clear("@"+t[u]),t.splice(u,1))}}}for(var u in r.urlsGraph)!e[u]&&l[u]||(!e[u]||l[u]?l[u]<e[u]&&s(u):s(u));i.length&&n.del("_states",i),a.length&&n.upsert("_invalidations",a)},on:function(e,t){u[e]=t}}}([c,a,p,S,s,v]),P=function(e,t){var n=e[0].ilike,r=e[1];var i={">":function(e,t){return e>t},">=":function(e,t){return e>=t},"<":function(e,t){return e<t},"<=":function(e,t){return e<=t},"=":function(e,t){return e===t},"!=":function(e,t){return e!==t},$text:function(e,t){return n.call(null,[t],e)},$where:function(e,t){return t.call(null,e)},$in:function(e,t){return t.indexOf(e)>-1},$nin:function(e,t){return-1===t.indexOf(e)},$and:function(e,t){for(var n=0,r=e.length;n<r;n++)if(!o(e[n],t))return!1;return!0},$or:function(e,t){for(var n=0,r=e.length;n<r;n++)if(o(e[n],t))return!0;return!1}};function o(e,t){return i[e.operator]?i[e.operator].call(null,t[e.attribute],e.value):!!e.$and&&i.$and.call(null,e.$and,t)}function a(e,t){return timsort.sort(t,function(e){for(var t="",n=0;n<e.length;n++){for(var r=e[n].split(" "),i=r[0].split("."),o="DESC"===r[1]?-1:1,a="";i.length;)t+="if (itemA"+(a+='["'+i.shift()+'"]')+" == null) { return 1; }",t+="if (itemB"+a+" == null) { return -1; }";t+="\nif (itemA"+a+" > itemB"+a+") {",t+="\n  return "+o+";",t+="\n}",t+="\nif (itemA"+a+" < itemB"+a+") {",t+="\n  return -("+o+");",t+="\n}"}return t+="\nreturn 0;",new Function("itemA","itemB",t)}(e)),t}function s(e){for(var t=[],n=[],i=0;i<e.length;i++){var o=e[i],a=[];for(var s in o){n.push(s);var l=o[s];if("object"!=typeof l)l={attribute:s,operator:"=",value:l},a.push(l);else for(var u in l)"$text"===u&&(l[u]=r.unaccent(l[u]).toLowerCase().split(" ")),a.push({attribute:s,operator:u,value:l[u]})}t.push({$and:a})}return{expressions:t,attributes:n}}return(t=function(e,t){var n={},o=!(!t||!1!==t.shouldClone);function l(){o||(e=r.clone(e),o=!0)}return n.count=function(){return e.length},n.data=function(t){return l(),t&&t.freeze&&(e=r.cloneAndFreeze(e)),e},n.sort=function(t){return t?(Array.isArray(t)||(t=[t]),l(),a(t,e),n):n},n.map=function(t){if("function"!=typeof t)throw new Error("mapFn is not a function");l();for(var r=[],i=0;i<e.length;i++)r[i]=t.call(null,e[i],i,r);return e=r,n},n.reduce=function(t,n){if("function"!=typeof t)throw new Error("reduceFn is not a function");l();for(var r=n&&void 0!==n.initialValue?n.initialValue:null,i=0;i<e.length;i++)r=t.call(null,r,e[i]);return r},n.mapReduce=function(t,n,r){if("function"!=typeof t)throw new Error("mapFn is not a function");if("function"!=typeof n)throw new Error("reduceFn is not a function");l();for(var i=[],o=r&&void 0!==r.initialValue?r.initialValue:null,a=0;a<e.length;a++)i[a]=t.call(null,e[a],a,i),o=n.call(null,o,i[a]);return e=i,o},n.where=function(t){if("function"!=typeof t)throw new Error("fn is not a function");l();var r=function(e,t){for(var n=[],r=0;r<t.length;r++){e.call(null,t[r])&&n.push(t[r])}return n}(t,e);return e=r,n},n.find=function(t){return e=function(e,t){var n=[],r=[],o=[];e.$or&&(o=e.$or,Array.isArray(o)||(o=[o]),delete e.$or),e.$and?(r=e.$and,Array.isArray(r)||(r=[r])):r=[e];var a=s(r),l=s(o);r=a.expressions,o=l.expressions;for(var u=a.attributes.concat(l.attributes),c=0,f=t.length;c<f;c++){for(var d=t[c],v={},h=0;h<u.length;h++){for(var p=d,g=u[h].split(".");g.length;){var m=g.shift();if(null==p[m]){v[u[h]]=void 0;break}p=p[m]}v[u[h]]=p}var b=!0;r.length&&!(b=i.$and(r,v))||(o.length&&(b=i.$or(o,v)),b&&n.push(d))}return n}(t,e),n},n}).operators=i,t}([E,u],{}),k=function(e,t){var n=e[0],r=e[1],i=e[2];return function(e){var t=r.getStore(e);if(t.isStoreObject)throw new Error("Cannot initialize a CollectionResultSet on a store object");var o=r.getCollection(t),a=n.clone(o.getAll());return i(a)}}([u,f,P]),R=function(e,t){var n=e[0],r=e[1],i=e[2],o=e[3],a=e[4],s=e[5],l=e[6],u=e[7],c=e[8],f=e[9],d=e[10],v=e[11],h=e[12],p=e[13],g=e[14],m=e[15],b=e[16],y=e[17],O=e[18];return l.getTranslatedStoreName=o.getTranslatedStoreName,f.pushOfflineHttpTransactions=i.pushOfflineHttpTransactions,f.getLastSyncDate=i.getLastSyncDate,f.load=r.load,{_stores:a._stores,_collection:s.collection,_cache:d,_resetVersionNumber:s.resetVersionNumber,_indexedDB:p.indexedDB,_removeAllHooks:n.removeAllHooks,_initStore:m.load,collectionResultSet:b,dynamicView:y,devtools:O,utils:l,logger:u,hook:n.hook,removeHook:n.removeHook,pushToHandlers:n.pushToHandlers,http:c,websocket:h,offline:f,localStorage:p.localStorage,get:r.get,getOne:r.getOne,insert:r.insert,update:r.update,upsert:r.upsert,delete:r.delete,load:r.load,clear:r.clear,rollback:r.rollback,getDefaultValue:r.getDefaultValue,validate:r.validate,setPagination:r.setPagination,createUrl:r.createUrl,begin:v.begin,commit:v.commit,invalidate:g.invalidate,invalidations:{init:g.init,compute:g.computeInvalidations,on:g.on,_invalidations:g.invalidations,getAndCompute:function(){h.subscribe("invalidations",(function(e){lunaris.websocket.unsubscribe("invalidations"),g.computeInvalidations(e.data,Object.keys(a._stores))})),h.send("invalidations")}},OPERATIONS:l.OPERATIONS,exports:a,get constants(){return a.constants}}}([l,S,O,f,a,d,u,s,m,v,p,g,_,c,I,A,k,function(e,t){var n=e[0],r=e[1],i=e[2],o=e[3];return function(e,t){var a=n.getStore(e),s={idIdx:{}},l=[],u=!1,c=[];if(s.shouldNotInitialize=!(!t||!t.shouldNotInitialize),a.isStoreObject)throw new Error("Cannot initialize a DynamicView on a store object");function f(){u||s.shouldNotInitialize||s.materialize()}function d(e){Array.isArray(e)||(e=[e]);for(var t=function(e){for(var t=o(e,{shouldClone:!1}),n=0;n<c.length;n++){var r=c[n];t[r.type].call(null,r.args)}return t.data()}(e),n=s.idIdx,r=0,i=t.length;r<i;r++){var a=t[r];null==n[a._id]?(n[a._id]=l.length,l.push(a)):l.splice(n[a._id],1,a)}}function v(e){for(var t=e,n=l.length;t<n;t++)s.idIdx[l[t]._id]--}function h(e){Array.isArray(e)||(e=[e]);for(var t=s.idIdx,n=0,r=e.length;n<r;n++)null!=t[e[n]._id]&&(l.splice(t[e[n]._id],1),v(t[e[n]._id]),t[e[n]._id]=null)}function p(){l.splice(0),s.idIdx={},c=[],u=!1}return s.count=function(){return f(),l.length},s.data=function(){return f(),l},s.materialize=function(){for(var t=i(e),n=0;n<c.length;n++){var r=c[n];t[r.type].call(null,r.args)}l=t.data(),u=!0},s.applyFindCriteria=function(e,t){return c.push({id:t,args:e,type:"find"}),s},s.applyWhereCriteria=function(e,t){return c.push({id:t,args:e,type:"where"}),s},s.applySortCriteria=function(e,t){return c.push({id:t,args:e,type:"sort"}),s},s.removeCriteria=function(e){for(var t=0,n=c.length;t<n;t++)if(c[t].id===e&&e){c.splice(t,1);break}return s},s.removeCriterias=function(){return c=[],s},s.resultSet=function(){return o(l)},s.destroy=function(){r.removeHook("get@"+a.name,d),r.removeHook("insert@"+a.name,d),r.removeHook("update@"+a.name,d),r.removeHook("delete@"+a.name,h),r.removeHook("reset@"+a.name,p)},r.hook("get@"+a.name,d),r.hook("insert@"+a.name,d),r.hook("update@"+a.name,d),r.hook("delete@"+a.name,h),r.hook("reset@"+a.name,p),s._update=d,s._remove=h,s}}([f,l,k,P]),{send:function(e){var t=new CustomEvent("lunaris-devtools",{detail:e});window.dispatchEvent(t)}}]);e.lunaris=R}("undefined"!=typeof module?global:this);